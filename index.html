<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itsbad Config Generator + Sub</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M13 2L3 14h9l-1 8 10-12h-9l1-8z'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { bg: '#09090b', glass: '#18181b', primary: '#6366f1' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #09090b; color: #e4e4e7; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .glass { background: rgba(24, 24, 27, 0.95); border: 1px solid rgba(255,255,255,0.08); }
        
        /* Input Styles */
        .input-dark { background: #0f0f11; border: 1px solid #27272a; color: #f4f4f5; width: 100%; border-radius: 4px; padding: 6px 10px; font-size: 12px; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: #6366f1; background: #151518; }
        
        /* Label Styles */
        .lbl-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .lbl { font-size: 10px; color: #71717a; font-weight: bold; text-transform: uppercase; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        
        /* Checkbox Custom */
        .check-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; border-radius: 6px; border: 1px solid transparent; background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s; }
        .check-item:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.1); }
        .check-item input { accent-color: #6366f1; width: 14px; height: 14px; cursor: pointer; }
        
        /* Help Button (!) */
        .help-icon { 
            width: 14px; height: 14px; 
            border-radius: 50%; 
            background: #27272a; 
            color: #a1a1aa; 
            font-size: 9px; 
            font-weight: bold; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; 
        }
        .help-icon:hover { background: #6366f1; color: white; }

        /* Mode Button */
        .mode-btn { transition: 0.2s; border: 1px solid transparent; position: relative; }
        .mode-btn.active { background: rgba(99, 102, 241, 0.15); border-color: #6366f1; color: white; }
        .mode-help { position: absolute; top: 4px; right: 4px; }
        
        /* Tabs */
        .tab-btn { padding: 10px 5px; font-size: 10px; font-weight: bold; color: #52525b; border-bottom: 2px solid transparent; transition: 0.2s; width: 33.33%; text-align: center; }
        .tab-btn:hover { color: #d4d4d8; }
        .tab-btn.active { color: #6366f1; border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }
        
        /* Section Divider */
        .divider { border-bottom: 1px solid #27272a; padding-bottom: 5px; margin-bottom: 10px; margin-top: 15px; color: #a1a1aa; font-weight: bold; font-size: 11px; display: flex; align-items: center; gap: 5px; }
        
        /* Modal & Utils */
        #help-modal { transition: opacity 0.2s; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen p-2 md:p-6">

    <div class="max-w-7xl mx-auto mb-4 flex justify-between items-center px-2">
        <h1 class="text-xl font-bold text-white flex items-center gap-2">
            <span class="text-primary text-2xl">‚ö°</span> Itsbad <span class="text-zinc-500 font-normal">Config Generator</span>
        </h1>
        <div class="text-[10px] font-mono text-zinc-600 border border-zinc-900 px-2 py-1 rounded bg-black/20">Dev: Itsbad</div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-4 pb-20">
        
        <div class="lg:col-span-5 space-y-4">
            
            <div class="glass p-4 rounded-lg border-t-2 border-t-primary">
                <div class="flex justify-between mb-2 items-end">
                    <label class="text-xs font-bold text-zinc-400">1. CONFIG INPUT</label>
                    <span id="node-count" class="text-[10px] text-primary bg-primary/10 px-2 py-0.5 rounded">0 nodes</span>
                </div>
                <textarea id="input-config" class="w-full h-24 bg-black/40 border border-zinc-800 rounded p-3 text-[11px] font-mono text-zinc-300 focus:border-primary focus:outline-none resize-none placeholder-zinc-700" placeholder="vmess://... vless://... trojan://..."></textarea>
                <div class="flex justify-end mt-1">
                    <button onclick="clearInput()" class="text-[10px] text-zinc-500 hover:text-red-400 transition">Clear Input</button>
                </div>
            </div>

            <div class="glass p-4 rounded-lg">
                <label class="text-xs font-bold text-zinc-400 mb-3 block">2. SELECT MODE</label>
                <div class="grid grid-cols-4 gap-2">
                    <div onclick="toggleMode('url-test')" id="btn-url-test" class="mode-btn glass p-2 rounded flex flex-col items-center cursor-pointer active text-center">
                        <span class="mode-help help-icon" onclick="showHelp(event, 'mode_auto')">!</span>
                        <span class="text-lg mb-1">‚ö°</span> <span class="text-[10px] font-bold">AUTO</span>
                    </div>
                    <div onclick="toggleMode('select')" id="btn-select" class="mode-btn glass p-2 rounded flex flex-col items-center cursor-pointer text-center">
                        <span class="mode-help help-icon" onclick="showHelp(event, 'mode_manual')">!</span>
                        <span class="text-lg mb-1">‚öôÔ∏è</span> <span class="text-[10px] font-bold">MANUAL</span>
                    </div>
                    <div onclick="toggleMode('load-balance')" id="btn-load-balance" class="mode-btn glass p-2 rounded flex flex-col items-center cursor-pointer text-center">
                        <span class="mode-help help-icon" onclick="showHelp(event, 'mode_lb')">!</span>
                        <span class="text-lg mb-1">üöÄ</span> <span class="text-[10px] font-bold">LB</span>
                    </div>
                    <div onclick="toggleMode('fallback')" id="btn-fallback" class="mode-btn glass p-2 rounded flex flex-col items-center cursor-pointer text-center">
                        <span class="mode-help help-icon" onclick="showHelp(event, 'mode_fallback')">!</span>
                        <span class="text-lg mb-1">üõ°Ô∏è</span> <span class="text-[10px] font-bold">FALLBACK</span>
                    </div>
                </div>
            </div>

            <div class="glass p-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-white">3. NETWORK SETTINGS</h3>
                    <button onclick="resetSettings()" class="text-[10px] text-zinc-600 hover:text-white">Reset Default</button>
                </div>

                <div class="divider">CONNECTION</div>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <label class="check-item"><div class="flex gap-2 text-[10px]"><input type="checkbox" id="always-reconnect" checked><span>Always Reconnect</span></div><span class="help-icon" onclick="showHelp(event, 'always_reconnect')">!</span></label>
                    <label class="check-item"><div class="flex gap-2 text-[10px]"><input type="checkbox" id="wakelock" checked><span>WakeLock ON</span></div><span class="help-icon" onclick="showHelp(event, 'wakelock')">!</span></label>
                    <label class="check-item"><div class="flex gap-2 text-[10px]"><input type="checkbox" id="allow-lan" checked><span>Allow LAN</span></div><span class="help-icon" onclick="showHelp(event, 'allow_lan')">!</span></label>
                </div>

                <div class="divider">DNS CONFIGURATION</div>
                <div class="mb-3">
                    <div class="lbl-container"><span class="lbl">DNS MODE SELECTOR</span><span class="help-icon" onclick="showHelp(event, 'dns_selector')">!</span></div>
                    <select id="dns-mode" onchange="toggleDnsFields()" class="input-dark cursor-pointer">
                        <option value="default">Default (System/ISP) - No Override</option>
                        <option value="fake-ip" selected>‚ö° Fake-IP (Anti-Bengong)</option>
                        <option value="custom">Custom IP (Redir-Host)</option>
                    </select>
                </div>

                <div id="dns-fields">
                    <div class="grid grid-cols-3 gap-3 mb-2">
                        <div>
                            <div class="lbl-container"><span class="lbl">DNS PORT</span><span class="help-icon" onclick="showHelp(event, 'dns_port')">!</span></div>
                            <input type="number" id="dns-port" value="7200" class="input-dark">
                        </div>
                        <div class="col-span-2">
                            <div class="lbl-container"><span class="lbl">DNS PRIMARY</span><span class="help-icon" onclick="showHelp(event, 'dns_pri')">!</span></div>
                            <input type="text" id="dns-primary" value="1.1.1.1" class="input-dark">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-2">
                        <div></div> <div class="col-span-2">
                            <div class="lbl-container"><span class="lbl">DNS SECONDARY</span><span class="help-icon" onclick="showHelp(event, 'dns_sec')">!</span></div>
                            <input type="text" id="dns-secondary" value="1.0.0.1" class="input-dark">
                        </div>
                    </div>
                </div>

                <div class="divider">PORTS & TUN</div>
                <div class="grid grid-cols-4 gap-3 mb-2">
                    <div>
                        <div class="lbl-container"><span class="lbl">HTTP</span><span class="help-icon" onclick="showHelp(event, 'http_port')">!</span></div>
                        <input type="number" id="http-port" value="8800" class="input-dark">
                    </div>
                    <div>
                        <div class="lbl-container"><span class="lbl">SOCKS</span><span class="help-icon" onclick="showHelp(event, 'socks_port')">!</span></div>
                        <input type="number" id="socks-port" value="3080" class="input-dark">
                    </div>
                    <div>
                        <div class="lbl-container"><span class="lbl">UDPGW</span><span class="help-icon" onclick="showHelp(event, 'udpgw')">!</span></div>
                        <input type="number" id="udpgw" value="7300" class="input-dark">
                    </div>
                    <div>
                        <div class="lbl-container"><span class="lbl">MTU</span><span class="help-icon" onclick="showHelp(event, 'mtu')">!</span></div>
                        <input type="number" id="mtu" value="1500" class="input-dark">
                    </div>
                </div>

                <div class="divider">TIMING & RECONNECT</div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <div class="lbl-container"><span class="lbl">INTERVAL</span><span class="help-icon" onclick="showHelp(event, 'interval')">!</span></div>
                        <input type="number" id="interval" value="1000" class="input-dark">
                    </div>
                    <div>
                        <div class="lbl-container"><span class="lbl">TIMEOUT</span><span class="help-icon" onclick="showHelp(event, 'timeout')">!</span></div>
                        <input type="number" id="timeout" value="3000" class="input-dark">
                    </div>
                    <div>
                        <div class="lbl-container"><span class="lbl">RETRY</span><span class="help-icon" onclick="showHelp(event, 'reconnect')">!</span></div>
                        <input type="text" id="reconnect-count" value="3x" class="input-dark text-center">
                    </div>
                </div>

                <div class="divider">GROUP & EXTRAS</div>
                <div class="mb-3">
                    <div class="lbl-container"><span class="lbl">NAMA GRUP (OUTPUT)</span><span class="help-icon" onclick="showHelp(event, 'group_name')">!</span></div>
                    <input type="text" id="group-name" value="Itsbad VPN" class="input-dark font-bold text-primary">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <label class="check-item"><div class="flex gap-2 text-[10px]"><input type="checkbox" id="skip-cert" checked><span>Skip Cert Verify</span></div><span class="help-icon" onclick="showHelp(event, 'skip_cert')">!</span></label>
                    <label class="check-item"><div class="flex gap-2 text-[10px]"><input type="checkbox" id="block-ads"><span>Block Ads</span></div><span class="help-icon" onclick="showHelp(event, 'block_ads')">!</span></label>
                </div>

                <button onclick="generateScript()" class="w-full py-3 bg-primary hover:bg-indigo-500 text-white font-bold rounded mt-5 shadow-lg shadow-indigo-500/20 transition text-sm">GENERATE CONFIG</button>
            </div>
        </div>

        <div class="lg:col-span-7">
            <div class="glass flex flex-col rounded-lg overflow-hidden h-[650px] border border-zinc-800">
                
                <div class="bg-black/40 border-b border-zinc-800 flex items-center">
                    <button onclick="switchTab('js')" id="tab-js" class="tab-btn active">JS (Override)</button>
                    <button onclick="switchTab('yaml')" id="tab-yaml" class="tab-btn">YAML (Config)</button>
                    <button onclick="switchTab('sub')" id="tab-sub" class="tab-btn">SUBSCRIPTION (Base64)</button>
                </div>

                <div id="view-js" class="flex-1 flex flex-col h-full">
                    <div class="p-2 border-b border-zinc-800/50 flex justify-between items-center bg-zinc-900/30">
                        <span class="text-[10px] text-zinc-500 pl-2">Format: JS Override</span>
                        <div class="flex gap-2">
                            <button onclick="copyText('js')" class="text-[10px] bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-1 rounded">Copy JS</button>
                            <button onclick="downloadFile('js')" class="text-[10px] bg-primary hover:bg-indigo-600 text-white px-3 py-1 rounded">Save .js</button>
                        </div>
                    </div>
                    <textarea id="output-js" readonly class="flex-1 bg-black/50 p-4 font-mono text-[10px] leading-relaxed text-blue-200/80 resize-none focus:outline-none placeholder-zinc-700"></textarea>
                </div>

                <div id="view-yaml" class="hidden flex-1 flex flex-col h-full">
                    <div class="p-2 border-b border-zinc-800/50 flex justify-between items-center bg-zinc-900/30">
                        <span class="text-[10px] text-zinc-500 pl-2">Format: Standard YAML</span>
                        <div class="flex gap-2">
                            <button onclick="copyText('yaml')" class="text-[10px] bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-1 rounded">Copy YAML</button>
                            <button onclick="downloadFile('yaml')" class="text-[10px] bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 rounded">Save .yaml</button>
                        </div>
                    </div>
                    <textarea id="output-yaml" readonly class="flex-1 bg-black/50 p-4 font-mono text-[10px] leading-relaxed text-yellow-100/80 resize-none focus:outline-none placeholder-zinc-700"></textarea>
                </div>

                <div id="view-sub" class="hidden flex-1 flex flex-col h-full">
                    <div class="p-2 border-b border-zinc-800/50 flex justify-between items-center bg-zinc-900/30">
                        <span class="text-[10px] text-zinc-500 pl-2">Format: Base64 (Import from Clipboard)</span>
                        <div class="flex gap-2">
                            <button onclick="copyText('sub')" class="text-[10px] bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded font-bold">COPY SUB</button>
                        </div>
                    </div>
                    <div class="flex-1 bg-black/50 p-4 relative">
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-zinc-700 text-4xl font-bold opacity-20 transform -rotate-12">BASE64 DATA</span>
                        </div>
                        <textarea id="output-sub" readonly class="w-full h-full bg-transparent font-mono text-[10px] leading-relaxed text-green-200/80 resize-none focus:outline-none placeholder-zinc-700"></textarea>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="help-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-6 backdrop-blur-sm" onclick="closeHelp()">
        <div class="bg-[#18181b] border border-zinc-700 w-full max-w-sm rounded-xl p-6 shadow-2xl relative" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-lg font-bold text-primary mb-2">Title</h3>
            <p id="modal-desc" class="text-sm text-zinc-300 leading-relaxed whitespace-pre-line mb-6">Description goes here.</p>
            <button onclick="closeHelp()" class="absolute top-4 right-4 text-zinc-500 hover:text-white">&times;</button>
            <button onclick="closeHelp()" class="w-full py-2 bg-zinc-800 rounded text-xs font-bold text-zinc-300 hover:bg-zinc-700">TUTUP PENJELASAN</button>
        </div>
    </div>

    <script>
        // State
        const activeModes = new Set(['url-test']);
        
        // --- DATA PENJELASAN (DOKUMENTASI) ---
        const helpData = {
            'mode_auto': {t: "Auto Ping (Url-Test)", d: "Mode ini akan mengetes ping semua akun secara berkala, lalu otomatis menggunakan akun dengan ping terendah (tercepat)."},
            'mode_manual': {t: "Manual Select", d: "Membuat grup di mana Anda harus memilih sendiri server yang ingin digunakan di menu Proxy FlyClash."},
            'mode_lb': {t: "Load Balance", d: "Menggabungkan bandwidth beberapa akun. Traffic dibagi rata ke semua server. Bisa meningkatkan speed download."},
            'mode_fallback': {t: "Fallback", d: "Sistem cadangan. Selalu menggunakan Server 1. Jika Server 1 mati, otomatis pindah ke Server 2."},
            
            'always_reconnect': {t: "Always Reconnect", d: "Memerintahkan aplikasi untuk otomatis menghubungkan ulang VPN jika koneksi terputus tiba-tiba."},
            'wakelock': {t: "WakeLock", d: "Mencegah CPU HP masuk mode tidur (sleep) saat layar mati, agar koneksi VPN tidak putus di background."},
            'allow_lan': {t: "Allow LAN", d: "Mengizinkan perangkat lain (HP/Laptop) yang terhubung ke Wifi/Hotspot Anda untuk ikut menggunakan VPN ini."},
            
            'http_port': {t: "HTTP Port", d: "Port untuk protokol HTTP Proxy. Default: 8800."},
            'socks_port': {t: "SOCKS5 Port", d: "Port untuk protokol SOCKS5 Proxy. Default: 3080."},
            'udpgw': {t: "UDPGW Port", d: "UDP Gateway. Sangat penting untuk Game Online dan Call WA. Default: 7300."},
            'mtu': {t: "MTU", d: "Maximum Transmission Unit. Ukuran paket data. Standar 1500. Jika sering RTO, coba turunkan ke 1400 atau 1280."},
            
            'dns_selector': {t: "DNS Mode", d: "Pilih strategi DNS:\n- Default: Ikut settingan App (Aman).\n- Fake-IP: Anti Bengong (Recommended).\n- Custom: Pakai IP DNS pilihan sendiri."},
            'dns_port': {t: "DNS Port", d: "Port internal untuk DNS Server Clash."},
            'dns_pri': {t: "DNS Primary", d: "DNS Utama. Disarankan 1.1.1.1 (Cloudflare) atau 8.8.8.8 (Google)."},
            'dns_sec': {t: "DNS Secondary", d: "DNS Cadangan jika DNS utama gagal."},
            
            'interval': {t: "Ping Interval", d: "Seberapa sering (ms) Clash mengecek ping server. 1000ms = 1 detik."},
            'timeout': {t: "Timeout", d: "Batas waktu tunggu (ms) sebelum koneksi dianggap gagal (RTO)."},
            'reconnect': {t: "Auto Reconnect", d: "Jumlah percobaan koneksi ulang otomatis sebelum menyerah."},
            
            'group_name': {t: "Nama Grup Output", d: "Nama yang akan muncul di menu Proxy. Default 'Itsbad VPN'."},
            
            'skip_cert': {t: "Skip Certificate Verify", d: "Melewati verifikasi sertifikat SSL. Wajib ON untuk akun gratisan/self-signed."},
            'block_ads': {t: "Block Ads", d: "Menambahkan aturan otomatis untuk memblokir domain iklan (Google Ads, dll)."}
        };

        // Functions
        function toggleMode(mode) {
            const btn = document.getElementById('btn-' + mode);
            if (activeModes.has(mode)) {
                if (activeModes.size > 1) { activeModes.delete(mode); btn.classList.remove('active'); }
            } else { activeModes.add(mode); btn.classList.add('active'); }
        }

        function toggleDnsFields() {
            const mode = document.getElementById('dns-mode').value;
            const fields = document.getElementById('dns-fields');
            if(mode === 'default') {
                fields.classList.add('hidden');
            } else {
                fields.classList.remove('hidden');
            }
        }

        function clearInput() {
            document.getElementById('input-config').value = '';
            document.getElementById('node-count').innerText = '0 nodes';
        }

        function resetSettings() {
            if(confirm("Reset ke settingan default?")) window.location.reload();
        }

        function switchTab(tab) {
            document.getElementById('view-js').classList.add('hidden');
            document.getElementById('view-yaml').classList.add('hidden');
            document.getElementById('view-sub').classList.add('hidden');
            
            document.getElementById('tab-js').classList.remove('active');
            document.getElementById('tab-yaml').classList.remove('active');
            document.getElementById('tab-sub').classList.remove('active');

            document.getElementById('view-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('active');
        }

        function showHelp(e, key) {
            e.preventDefault(); e.stopPropagation();
            const data = helpData[key];
            if(data) {
                document.getElementById('modal-title').innerText = data.t;
                document.getElementById('modal-desc').innerText = data.d;
                document.getElementById('help-modal').classList.remove('hidden');
            }
        }

        function closeHelp() { document.getElementById('help-modal').classList.add('hidden'); }

        // --- PARSER ---
        // Helper untuk parse raw line
        function parseConfig(line, index) {
            try {
                if (line.startsWith("vmess://")) {
                    const b64 = line.replace("vmess://", "");
                    const conf = JSON.parse(atob(b64));
                    return {
                        original: line,
                        name: conf.ps || `VMess-${index}`, type: "vmess", server: conf.add, port: parseInt(conf.port), uuid: conf.id, alterId: parseInt(conf.aid || 0), cipher: "auto", tls: conf.tls === "tls", servername: conf.host || conf.sni || "", network: conf.net || "ws", "ws-opts": conf.net === "ws" ? { path: conf.path || "/", headers: { Host: conf.host || "" } } : undefined, "grpc-opts": conf.net === "grpc" ? { "grpc-service-name": conf.path || "grpc" } : undefined
                    };
                } else if (line.startsWith("vless://") || line.startsWith("trojan://")) {
                    const url = new URL(line);
                    const isVless = line.startsWith("vless://");
                    const params = url.searchParams;
                    const result = {
                        original: line,
                        name: decodeURIComponent(url.hash.slice(1)) || `${isVless ? 'VLESS' : 'Trojan'}-${index}`, type: isVless ? "vless" : "trojan", server: url.hostname, port: parseInt(url.port), uuid: url.username, password: isVless ? undefined : url.username, tls: params.get("security") === "tls" || params.get("security") === "reality", servername: params.get("sni") || "", network: params.get("type") || "tcp", "client-fingerprint": params.get("fp") || "chrome",
                    };
                    if (params.get("type") === "ws") result["ws-opts"] = { path: params.get("path") || "/", headers: { Host: params.get("host") || params.get("sni") || "" } };
                    if (params.get("type") === "grpc") result["grpc-opts"] = { "grpc-service-name": params.get("serviceName") || "grpc" };
                    if (params.get("security") === "reality") result["reality-opts"] = { "public-key": params.get("pbk") || "", "short-id": params.get("sid") || "" };
                    return result;
                }
                return null;
            } catch (e) { return null; }
        }

        // --- GENERATOR ---
        function generateScript() {
            const inputVal = document.getElementById('input-config').value;
            const lines = inputVal.split('\n').filter(l => l.trim().length > 5);
            const nodes = lines.map((l, i) => parseConfig(l.trim(), i)).filter(n => n !== null);
            document.getElementById('node-count').innerText = nodes.length + ' nodes';

            if (nodes.length === 0) {
                document.getElementById('output-js').value = "// Error: Config kosong";
                document.getElementById('output-yaml').value = "# Error: Config kosong";
                document.getElementById('output-sub').value = "";
                return;
            }

            // GET SETTINGS
            const alwaysReconnect = document.getElementById('always-reconnect').checked;
            const wakelock = document.getElementById('wakelock').checked;
            const allowLan = document.getElementById('allow-lan').checked;
            const groupName = document.getElementById('group-name').value;
            
            const httpPort = document.getElementById('http-port').value;
            const socksPort = document.getElementById('socks-port').value;
            const udpgw = document.getElementById('udpgw').value;
            const mtu = document.getElementById('mtu').value;
            
            const dnsMode = document.getElementById('dns-mode').value;
            const dnsPort = document.getElementById('dns-port').value;
            const dnsPri = document.getElementById('dns-primary').value;
            const dnsSec = document.getElementById('dns-secondary').value;
            
            const interval = document.getElementById('interval').value;
            const timeout = document.getElementById('timeout').value;
            const reconnectCount = document.getElementById('reconnect-count').value;
            
            const skipCert = document.getElementById('skip-cert').checked;
            const blockAds = document.getElementById('block-ads').checked;

            const intervalSec = Math.floor(interval / 1000); 

            nodes.forEach(n => {
                if (skipCert) n['skip-cert-verify'] = true;
                n.udp = true;
            });

            // 1. JS
            const activeModesArr = Array.from(activeModes);
            let rulesJS = [];
            if(blockAds) rulesJS.push("DOMAIN-KEYWORD,ads,REJECT", "DOMAIN-SUFFIX,doubleclick.net,REJECT");
            const rulesStr = JSON.stringify(rulesJS);

            const groupsStr = activeModesArr.map(mode => {
                let niceName = mode === 'url-test' ? "AUTO" : mode === 'select' ? "MANUAL" : mode === 'load-balance' ? "LB" : "FALLBACK";
                return `{
        "name": "${groupName} (${niceName})",
        "type": "${mode}",
        "url": "http://www.gstatic.com/generate_204",
        "interval": ${intervalSec}, 
        "timeout": ${timeout},
        ${mode === 'load-balance' ? '"strategy": "consistent-hashing",' : ''}
        ${mode === 'fallback' ? '"lazy": true,' : ''}
        "proxies": proxies.map(p => p.name)
    }`;
            }).join(",\n    ");

            let dnsJS = "// DNS: Default (No Override)";
            if (dnsMode !== 'default') {
                dnsJS = `config.dns = {
        "enable": true,
        "ipv6": false,
        "listen": "0.0.0.0:${dnsPort}",
        "enhanced-mode": "${dnsMode === 'fake-ip' ? 'fake-ip' : 'redir-host'}",
        "fake-ip-range": "198.18.0.1/16",
        "default-nameserver": ["${dnsPri}", "${dnsSec}"],
        "nameserver": ["${dnsPri}", "${dnsSec}", "https://dns.google/dns-query"],
        "fallback": ["https://doh.pub/dns-query", "${dnsPri}"],
    };`;
            }

            const jsOutput = `/**
 * FlyClash Override Generated
 * Dev: Itsbad
 * Group: ${groupName}
 * * [SETTINGS ACTIVE]
 * - Always Reconnect: ${alwaysReconnect}
 * - WakeLock: ${wakelock}
 * - Auto Reconnect: ${reconnectCount}
 * - UDPGW: ${udpgw}
 */

function main(config) {
    const proxies = ${JSON.stringify(nodes, null, 2)};
    config.proxies = (config.proxies || []).concat(proxies);
    
    // PORTS & TUN
    config['port'] = ${httpPort};
    config['socks-port'] = ${socksPort};
    config['redir-port'] = ${udpgw};
    config['mixed-port'] = 7890;
    config['allow-lan'] = ${allowLan};
    config['ipv6'] = false;
    
    // TUN SETTINGS
    config['tun'] = {
        "enable": true,
        "stack": "system",
        "device": "tun0",
        "auto-route": true,
        "auto-detect-interface": true,
        "dns-hijack": ["any:53"],
        "mtu": ${mtu}
    };

    ${dnsJS}

    // GROUPS
    const newGroups = [
    ${groupsStr}
    ];

    if (!config['proxy-groups']) config['proxy-groups'] = [];
    config['proxy-groups'].unshift(...newGroups);

    // RULES
    const newRules = ${rulesStr};
    if(newRules.length > 0) config.rules = newRules.concat(config.rules || []);

    // AUTO ADD TO SELECTORS
    config['proxy-groups'].forEach(g => {
        if (g.type === 'select' && !newGroups.find(ng => ng.name === g.name)) {
            newGroups.forEach(ng => g.proxies.push(ng.name));
        }
    });

    return config;
}`;
            document.getElementById('output-js').value = jsOutput;

            // 2. YAML
            let yaml = `# FlyClash Config - Dev: Itsbad
# Group: ${groupName}
# Settings: WakeLock=${wakelock}, Reconnect=${alwaysReconnect} (${reconnectCount})
# MTU=${mtu}, UDPGW=${udpgw}

port: ${httpPort}
socks-port: ${socksPort}
redir-port: ${udpgw}
mixed-port: 7890
allow-lan: ${allowLan}
mode: rule
log-level: info
ipv6: false

tun:
  enable: true
  stack: system
  device: tun0
  auto-route: true
  auto-detect-interface: true
  dns-hijack:
    - any:53
  mtu: ${mtu}
`;

            if (dnsMode !== 'default') {
                yaml += `
dns:
  enable: true
  ipv6: false
  listen: 0.0.0.0:${dnsPort}
  enhanced-mode: ${dnsMode === 'fake-ip' ? 'fake-ip' : 'redir-host'}
  fake-ip-range: 198.18.0.1/16
  default-nameserver:
    - ${dnsPri}
    - ${dnsSec}
  nameserver:
    - ${dnsPri}
    - ${dnsSec}
    - https://dns.google/dns-query
`;
            } else {
                yaml += `\n# DNS: Default System\n`;
            }

            yaml += `\nproxies:\n`;
            nodes.forEach(n => {
                yaml += `  - name: ${n.name}\n    type: ${n.type}\n    server: ${n.server}\n    port: ${n.port}\n    uuid: ${n.uuid}\n    cipher: ${n.cipher || 'auto'}\n    udp: true\n    tls: ${n.tls}\n    skip-cert-verify: ${n['skip-cert-verify']}\n    network: ${n.network}\n    servername: ${n.servername}\n`;
                if(n['ws-opts']) {
                    yaml += `    ws-opts:\n      path: ${n['ws-opts'].path}\n      headers:\n        Host: ${n['ws-opts'].headers.Host}\n`;
                }
            });

            yaml += `\nproxy-groups:\n`;
            activeModesArr.forEach(mode => {
                let niceName = mode === 'url-test' ? "AUTO" : mode === 'select' ? "MANUAL" : mode === 'load-balance' ? "LB" : "FALLBACK";
                yaml += `  - name: ${groupName} (${niceName})\n    type: ${mode}\n    url: http://www.gstatic.com/generate_204\n    interval: ${intervalSec}\n    timeout: ${timeout}\n`;
                if (mode === 'load-balance') yaml += `    strategy: consistent-hashing\n`;
                if (mode === 'fallback') yaml += `    lazy: true\n`;
                yaml += `    proxies:\n${nodes.map(n => `      - ${n.name}`).join('\n')}\n`;
            });

            yaml += `\nrules:\n`;
            if (blockAds) yaml += `  - DOMAIN-KEYWORD,ads,REJECT\n  - DOMAIN-SUFFIX,doubleclick.net,REJECT\n`;
            yaml += `  - MATCH,${groupName} (${activeModesArr.includes('url-test') ? 'AUTO' : 'MANUAL'})\n`;

            document.getElementById('output-yaml').value = yaml;

            // 3. SUBSCRIPTION (BASE64)
            // Mengambil link original, lalu encode ke Base64
            const rawLinks = nodes.map(n => n.original).join('\n');
            const base64Sub = btoa(rawLinks);
            document.getElementById('output-sub').value = base64Sub;
        }

        function copyText(type) {
            const el = document.getElementById('output-' + type);
            el.select();
            document.execCommand('copy');
            alert("Berhasil disalin!");
        }

        function downloadFile(type) {
            const txt = document.getElementById('output-' + type).value;
            const blob = new Blob([txt], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = type === 'js' ? 'flyclash-override.js' : 'config.yaml';
            a.click();
        }
    </script>
</body>
</html>

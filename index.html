<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyClash Override Generator</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        darker: '#020617',
                        primary: '#3b82f6',
                        accent: '#06b6d4',
                        success: '#10b981',
                        surface: '#1e293b'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .input-box { background: #0f172a; border: 1px solid #334155; color: #f8fafc; transition: all 0.3s; }
        .input-box:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        
        /* Syntax Highlight Colors */
        .token-keyword { color: #c678dd; }
        .token-string { color: #98c379; }
        .token-function { color: #61afef; }
        .token-comment { color: #5c6370; font-style: italic; }
        
        pre { white-space: pre-wrap; word-wrap: break-word; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Zap, Settings, Shield, Globe, Copy, Check, FileJson, Play, Save, Server, RefreshCw, AlertTriangle } = lucide;

        // --- PARSERS LOGIC ---
        
        // Helper: Safe JSON Parse
        const safeJsonParse = (str) => {
            try { return JSON.parse(str); } catch (e) { return null; }
        };

        // Parser: VMess
        const parseVmess = (link, idx) => {
            try {
                const b64 = link.replace("vmess://", "");
                const decoded = atob(b64);
                const conf = safeJsonParse(decoded);
                if (!conf) return null;
                
                return {
                    name: conf.ps || `VMess Node ${idx}`,
                    type: "vmess",
                    server: conf.add,
                    port: parseInt(conf.port) || 443,
                    uuid: conf.id,
                    alterId: parseInt(conf.aid || 0),
                    cipher: "auto",
                    udp: true,
                    tls: conf.tls === "tls",
                    "skip-cert-verify": true,
                    servername: conf.host || conf.sni || "",
                    network: conf.net || "ws",
                    "ws-opts": conf.net === "ws" ? {
                        path: conf.path || "/",
                        headers: { Host: conf.host || conf.sni || "" }
                    } : undefined,
                    "grpc-opts": conf.net === "grpc" ? {
                        "grpc-service-name": conf.path || "grpc"
                    } : undefined
                };
            } catch (e) { return null; }
        };

        // Parser: VLESS & Trojan
        const parseUrlConfig = (link, idx) => {
            try {
                const url = new URL(link);
                const params = url.searchParams;
                const isTrojan = link.startsWith("trojan://");
                
                const node = {
                    name: decodeURIComponent(url.hash.slice(1)) || `${isTrojan ? 'Trojan' : 'VLESS'} Node ${idx}`,
                    type: isTrojan ? "trojan" : "vless",
                    server: url.hostname,
                    port: parseInt(url.port) || 443,
                    udp: true,
                    tls: params.get("security") === "tls" || params.get("security") === "reality",
                    "skip-cert-verify": true,
                    servername: params.get("sni") || "",
                    network: params.get("type") || "tcp",
                };

                if (isTrojan) {
                    node.password = url.username;
                } else {
                    node.uuid = url.username;
                    node.cipher = "auto";
                    node["client-fingerprint"] = params.get("fp") || "chrome";
                }

                // WebSocket
                if (params.get("type") === "ws") {
                    node["ws-opts"] = {
                        path: params.get("path") || "/",
                        headers: { Host: params.get("host") || params.get("sni") || "" }
                    };
                }

                // gRPC
                if (params.get("type") === "grpc") {
                    node["grpc-opts"] = {
                        "grpc-service-name": params.get("serviceName") || "grpc"
                    };
                }

                // Reality (VLESS only)
                if (params.get("security") === "reality") {
                    node["reality-opts"] = {
                        "public-key": params.get("pbk") || "",
                        "short-id": params.get("sid") || ""
                    };
                }

                return node;
            } catch (e) { return null; }
        };

        // Parser: Shadowsocks
        const parseShadowsocks = (link, idx) => {
            // Basic SS parser (simplified for demo)
            try {
                const url = new URL(link);
                const userInfo = atob(url.username).split(':');
                return {
                    name: decodeURIComponent(url.hash.slice(1)) || `SS Node ${idx}`,
                    type: "ss",
                    server: url.hostname,
                    port: parseInt(url.port),
                    cipher: userInfo[0],
                    password: userInfo[1],
                    udp: true
                };
            } catch(e) { return null; }
        }

        // --- COMPONENT: APP ---

        const App = () => {
            // Inputs
            const [inputText, setInputText] = useState("");
            
            // Settings State
            const [mode, setMode] = useState("url-test"); // url-test, load-balance, fallback, select
            const [groupName, setGroupName] = useState("ðŸš€ FlyClash Proxy");
            const [customDNS, setCustomDNS] = useState("default");
            const [customPort, setCustomPort] = useState(7890);
            
            // Toggles
            const [toggles, setToggles] = useState({
                blockAds: false,
                appRules: false, // WA, TikTok
                allowLan: true,
                skipCert: true,
                topGroup: true // Add to top or bottom
            });

            // Outputs
            const [nodes, setNodes] = useState([]);
            const [outputScript, setOutputScript] = useState("");
            const [status, setStatus] = useState("idle"); // idle, processing, done
            const [copied, setCopied] = useState(false);

            // 1. Parsing Logic
            useEffect(() => {
                if (!inputText.trim()) {
                    setNodes([]);
                    return;
                }

                setStatus("processing");
                const lines = inputText.split(/\r?\n/).filter(l => l.trim().length > 5);
                const parsed = [];

                lines.forEach((line, i) => {
                    let node = null;
                    if (line.startsWith("vmess://")) node = parseVmess(line.trim(), i+1);
                    else if (line.startsWith("vless://") || line.startsWith("trojan://")) node = parseUrlConfig(line.trim(), i+1);
                    else if (line.startsWith("ss://")) node = parseShadowsocks(line.trim(), i+1);

                    if (node) {
                        // Apply global override if needed
                        if(toggles.skipCert) node['skip-cert-verify'] = true;
                        parsed.push(node);
                    }
                });

                setNodes(parsed);
                setStatus("done");
            }, [inputText, toggles.skipCert]);

            // 2. Generator Logic
            useEffect(() => {
                if (nodes.length === 0) {
                    setOutputScript("// Silakan masukkan link config V2Ray di panel kiri...");
                    return;
                }

                const nodesJson = JSON.stringify(nodes, null, 4);
                
                // Construct Group Object
                let groupType = "select";
                let strategy = "";
                let interval = "";

                if (mode === "url-test" || mode === "fallback") {
                    groupType = mode;
                    interval = `, "interval": 300, "tolerance": 50`;
                } else if (mode === "load-balance") {
                    groupType = "load-balance";
                    strategy = `, "strategy": "consistent-hashing"`;
                    interval = `, "interval": 300`;
                }

                // DNS Logic
                let dnsSection = "";
                if (customDNS === "google") {
                    dnsSection = `
    config.dns = {
        "enable": true,
        "ipv6": false,
        "enhanced-mode": "fake-ip",
        "fake-ip-range": "198.18.0.1/16",
        "nameserver": ["8.8.8.8", "8.8.4.4", "https://dns.google/dns-query"],
        "fallback": ["1.1.1.1"]
    };`;
                } else if (customDNS === "cloudflare") {
                    dnsSection = `
    config.dns = {
        "enable": true,
        "ipv6": false,
        "enhanced-mode": "fake-ip",
        "nameserver": ["1.1.1.1", "1.0.0.1", "https://cloudflare-dns.com/dns-query"],
        "fallback": ["8.8.8.8"]
    };`;
                }

                // Rules Logic
                let rulesSection = "";
                const rulesToAdd = [];
                
                if (toggles.blockAds) {
                    rulesToAdd.push('"DOMAIN-KEYWORD,ads,REJECT"');
                    rulesToAdd.push('"DOMAIN-SUFFIX,doubleclick.net,REJECT"');
                }
                
                if (toggles.appRules) {
                    rulesToAdd.push(`"DOMAIN-KEYWORD,whatsapp,${groupName}"`);
                    rulesToAdd.push(`"DOMAIN-SUFFIX,tiktokv.com,${groupName}"`);
                    rulesToAdd.push(`"DOMAIN-SUFFIX,mobilelegends.com,${groupName}"`);
                }

                if (rulesToAdd.length > 0) {
                    rulesSection = `
    // Inject Custom Rules
    const customRules = [
        ${rulesToAdd.join(',\n        ')}
    ];
    config.rules = customRules.concat(config.rules || []);`;
                }

                // Final Script Template
                const script = `// FlyClash Override Script
// Generated: ${new Date().toLocaleString()}
// Nodes Count: ${nodes.length}
// Mode: ${mode.toUpperCase()}

function main(config) {
    // 1. Add Proxies
    const newProxies = ${nodesJson};
    config.proxies = (config.proxies || []).concat(newProxies);

    // 2. Create Custom Group
    const nodeNames = newProxies.map(p => p.name);
    const mainGroup = {
        "name": "${groupName}",
        "type": "${groupType}",
        "proxies": nodeNames,
        "url": "http://www.gstatic.com/generate_204"
        ${interval}
        ${strategy}
    };

    // Ensure proxy-groups exists
    if (!config['proxy-groups']) config['proxy-groups'] = [];

    // Add Group (${toggles.topGroup ? 'Top' : 'Bottom'})
    ${toggles.topGroup 
      ? `config['proxy-groups'].unshift(mainGroup);` 
      : `config['proxy-groups'].push(mainGroup);`
    }

    // 3. Auto-add group to other selectors
    config['proxy-groups'].forEach(g => {
        if (g.type === 'select' && g.name !== "${groupName}") {
            g.proxies.push("${groupName}");
        }
    });

    // 4. General Settings
    config['mixed-port'] = ${customPort};
    config['allow-lan'] = ${toggles.allowLan};
    config['ipv6'] = false;

    // 5. DNS & Rules
    ${dnsSection}
    ${rulesSection}

    return config;
}`;
                setOutputScript(script);

            }, [nodes, mode, groupName, customDNS, customPort, toggles]);

            // Utils
            const handleToggle = (key) => setToggles(prev => ({...prev, [key]: !prev[key]}));
            
            const copyToClipboard = () => {
                navigator.clipboard.writeText(outputScript);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const downloadFile = () => {
                const blob = new Blob([outputScript], {type: 'text/javascript'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'flyclash_override.js';
                a.click();
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-[1400px] mx-auto flex flex-col gap-6">
                    
                    {/* Header */}
                    <div className="flex justify-between items-end pb-4 border-b border-slate-800">
                        <div>
                            <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300 flex items-center gap-2">
                                <Zap className="text-yellow-400 fill-yellow-400" /> FlyClash Generator
                            </h1>
                            <p className="text-slate-400 text-sm mt-1">Convert VMess/VLESS/Trojan to JS Override</p>
                        </div>
                        <div className="hidden md:block text-xs font-mono text-slate-600">v2.0.0 Stable</div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* LEFT COLUMN: Controls */}
                        <div className="lg:col-span-4 space-y-5">
                            
                            {/* Input Area */}
                            <div className="glass-panel rounded-xl p-4 flex flex-col gap-2">
                                <div className="flex justify-between items-center text-sm font-semibold text-slate-300">
                                    <span className="flex items-center gap-2"><Server size={16} className="text-accent"/> Input Links</span>
                                    <span className={`text-xs px-2 py-0.5 rounded-full ${nodes.length > 0 ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-400'}`}>
                                        {nodes.length} Detected
                                    </span>
                                </div>
                                <textarea 
                                    className="input-box w-full h-40 rounded-lg p-3 text-xs font-mono resize-none placeholder-slate-600"
                                    placeholder="Paste vmess://, vless://, trojan:// here..."
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                ></textarea>
                            </div>

                            {/* Mode Selection */}
                            <div className="glass-panel rounded-xl p-4 space-y-4">
                                <h2 className="text-sm font-semibold text-slate-300 flex items-center gap-2">
                                    <Settings size={16} className="text-primary"/> Mode Strategy
                                </h2>
                                <div className="grid grid-cols-2 gap-2">
                                    {[
                                        {id: 'url-test', label: 'Auto Ping', icon: Zap},
                                        {id: 'load-balance', label: 'Load Balance', icon: RefreshCw},
                                        {id: 'fallback', label: 'Fallback', icon: Shield},
                                        {id: 'select', label: 'Manual', icon: Play},
                                    ].map((m) => (
                                        <button 
                                            key={m.id}
                                            onClick={() => setMode(m.id)}
                                            className={`p-3 rounded-lg border text-left flex flex-col gap-1 transition-all ${mode === m.id ? 'bg-primary/20 border-primary text-white shadow-lg shadow-blue-500/10' : 'border-slate-700 text-slate-400 hover:bg-slate-800'}`}
                                        >
                                            <m.icon size={18} />
                                            <span className="text-xs font-medium">{m.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Configuration */}
                            <div className="glass-panel rounded-xl p-4 space-y-4">
                                <h2 className="text-sm font-semibold text-slate-300">Configuration</h2>
                                
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-xs text-slate-500 block mb-1">Group Name</label>
                                        <input type="text" value={groupName} onChange={e=>setGroupName(e.target.value)} className="input-box w-full p-2 rounded text-sm" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-xs text-slate-500 block mb-1">DNS Mode</label>
                                            <select value={customDNS} onChange={e=>setCustomDNS(e.target.value)} className="input-box w-full p-2 rounded text-sm cursor-pointer">
                                                <option value="default">Default</option>
                                                <option value="google">Google</option>
                                                <option value="cloudflare">Cloudflare</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs text-slate-500 block mb-1">Mixed Port</label>
                                            <input type="number" value={customPort} onChange={e=>setCustomPort(e.target.value)} className="input-box w-full p-2 rounded text-sm" />
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-2 border-t border-slate-700/50 grid grid-cols-2 gap-2">
                                    <ToggleBtn active={toggles.blockAds} onClick={()=>handleToggle('blockAds')} label="Block Ads" />
                                    <ToggleBtn active={toggles.appRules} onClick={()=>handleToggle('appRules')} label="App Rules (WA)" />
                                    <ToggleBtn active={toggles.allowLan} onClick={()=>handleToggle('allowLan')} label="Allow LAN" />
                                    <ToggleBtn active={toggles.skipCert} onClick={()=>handleToggle('skipCert')} label="Skip Cert" />
                                    <ToggleBtn active={toggles.topGroup} onClick={()=>handleToggle('topGroup')} label="Top Priority" />
                                </div>
                            </div>

                        </div>

                        {/* RIGHT COLUMN: Output */}
                        <div className="lg:col-span-8 flex flex-col h-full min-h-[500px]">
                            <div className="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden border-slate-700">
                                
                                {/* Toolbar */}
                                <div className="bg-surface border-b border-slate-700 p-3 flex justify-between items-center">
                                    <div className="flex items-center gap-2 text-slate-300 text-sm font-medium">
                                        <FileJson size={16} className="text-yellow-400" /> 
                                        Generated Script
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={downloadFile} className="flex items-center gap-1 px-3 py-1.5 rounded-md bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs transition">
                                            <Save size={14} /> Save .js
                                        </button>
                                        <button onClick={copyToClipboard} className={`flex items-center gap-1 px-3 py-1.5 rounded-md text-white text-xs transition ${copied ? 'bg-green-600' : 'bg-primary hover:bg-blue-600'}`}>
                                            {copied ? <Check size={14} /> : <Copy size={14} />}
                                            {copied ? "Copied" : "Copy Code"}
                                        </button>
                                    </div>
                                </div>

                                {/* Code Editor Look */}
                                <div className="flex-1 relative bg-[#0d1117] overflow-auto custom-scrollbar">
                                    <div className="absolute top-0 left-0 min-h-full w-10 bg-[#0d1117] border-r border-slate-800 flex flex-col items-end pt-4 pr-2 text-xs text-slate-600 font-mono select-none">
                                        {outputScript.split('\n').map((_, i) => <div key={i}>{i+1}</div>)}
                                    </div>
                                    <pre className="pl-12 pr-4 pt-4 pb-10 text-xs font-mono leading-relaxed">
                                        <code dangerouslySetInnerHTML={{__html: highlightSyntax(outputScript)}} />
                                    </pre>
                                </div>
                                
                                {/* Footer Status */}
                                <div className="bg-surface border-t border-slate-800 p-2 px-4 text-[10px] text-slate-500 flex justify-between font-mono">
                                    <span>TYPE: JAVASCRIPT OVERRIDE</span>
                                    <span>SIZE: {new Blob([outputScript]).size} BYTES</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // --- SUB COMPONENTS & HELPERS ---

        const ToggleBtn = ({ active, onClick, label }) => (
            <button 
                onClick={onClick}
                className={`flex items-center justify-between px-3 py-2 rounded-md text-xs transition-all border ${active ? 'bg-primary/10 border-primary text-blue-200' : 'bg-slate-800/50 border-transparent text-slate-400 hover:bg-slate-800'}`}
            >
                {label}
                <div className={`w-2 h-2 rounded-full ${active ? 'bg-primary shadow-[0_0_8px_rgba(59,130,246,0.8)]' : 'bg-slate-600'}`}></div>
            </button>
        );

        // Simple Syntax Highlighter for JS
        const highlightSyntax = (code) => {
            if (!code) return "";
            let html = code
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") // Escape HTML
                .replace(/(\/\/.*)/g, '<span class="token-comment">$1</span>') // Comments
                .replace(/\b(function|return|const|let|var|if|else|new|true|false|null)\b/g, '<span class="token-keyword">$1</span>') // Keywords
                .replace(/(".*?")/g, '<span class="token-string">$1</span>') // Strings
                .replace(/\b(push|unshift|concat|map|forEach|split)\b/g, '<span class="token-function">$1</span>'); // Functions
            return html;
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Init Icons
        lucide.createIcons();
    </script>
</body>
</html>

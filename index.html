<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyClash Converter Override (Native)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { bg: '#09090b', glass: '#18181b', primary: '#6366f1' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #09090b; color: #e4e4e7; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .glass { background: rgba(24, 24, 27, 0.9); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Input Styles */
        .input-dark { background: #09090b; border: 1px solid #3f3f46; color: #f4f4f5; width: 100%; border-radius: 6px; padding: 8px; font-size: 13px; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: #6366f1; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        
        /* Checkbox Custom */
        .check-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s; }
        .check-item:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.1); }
        .check-item input { accent-color: #6366f1; width: 16px; height: 16px; cursor: pointer; }
        
        /* Help Button */
        .help-btn { color: #71717a; padding: 0 5px; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .help-btn:hover { color: #fff; }

        /* Mode Button Active State */
        .mode-btn { transition: 0.2s; border: 1px solid transparent; }
        .mode-btn.active { background: rgba(99, 102, 241, 0.2); border-color: #6366f1; color: white; }
        
        /* Modal */
        #help-modal { transition: opacity 0.2s; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-white flex items-center gap-3">
            <span class="text-primary">‚ö°</span> FlyClash Converter Override
        </h1>
        <div class="text-xs font-mono text-zinc-500 border border-zinc-800 px-3 py-1 rounded-full">Dev: Itsbad</div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 pb-20">
        
        <div class="lg:col-span-5 space-y-6">
            
            <div class="glass p-5 rounded-xl border-l-4 border-l-primary">
                <div class="flex justify-between mb-2">
                    <label class="text-xs font-bold text-gray-400">1. INPUT CONFIG</label>
                    <span id="node-count" class="text-xs text-primary font-mono">0 nodes</span>
                </div>
                <textarea id="input-config" class="w-full h-32 bg-black/30 border border-zinc-700 rounded-lg p-3 text-xs font-mono text-gray-300 focus:border-primary focus:outline-none resize-none" placeholder="Paste vmess:// vless:// trojan:// di sini..."></textarea>
                <div class="flex justify-end mt-2">
                    <button onclick="clearInput()" class="text-xs text-red-400 hover:text-red-300">Clear</button>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-400 mb-2 block">2. PILIH MODE (Bisa Banyak)</label>
                <div class="grid grid-cols-2 gap-3">
                    <div onclick="toggleMode('url-test')" id="btn-url-test" class="mode-btn glass p-3 rounded-xl cursor-pointer flex justify-between items-center active">
                        <div class="flex items-center gap-2"><span class="text-lg">‚ö°</span> <span class="text-sm font-bold">Auto Ping</span></div>
                        <button onclick="showHelp(event, 'auto')" class="help-btn">?</button>
                    </div>
                    <div onclick="toggleMode('select')" id="btn-select" class="mode-btn glass p-3 rounded-xl cursor-pointer flex justify-between items-center">
                        <div class="flex items-center gap-2"><span class="text-lg">‚öôÔ∏è</span> <span class="text-sm font-bold">Manual</span></div>
                        <button onclick="showHelp(event, 'manual')" class="help-btn">?</button>
                    </div>
                    <div onclick="toggleMode('load-balance')" id="btn-load-balance" class="mode-btn glass p-3 rounded-xl cursor-pointer flex justify-between items-center">
                        <div class="flex items-center gap-2"><span class="text-lg">üîÑ</span> <span class="text-sm font-bold">Load Bal</span></div>
                        <button onclick="showHelp(event, 'lb')" class="help-btn">?</button>
                    </div>
                    <div onclick="toggleMode('fallback')" id="btn-fallback" class="mode-btn glass p-3 rounded-xl cursor-pointer flex justify-between items-center">
                        <div class="flex items-center gap-2"><span class="text-lg">üõ°Ô∏è</span> <span class="text-sm font-bold">Fallback</span></div>
                        <button onclick="showHelp(event, 'fallback')" class="help-btn">?</button>
                    </div>
                </div>
            </div>

            <div class="glass p-5 rounded-xl space-y-4">
                <h3 class="text-sm font-bold text-gray-200 border-b border-zinc-700 pb-2">3. PENGATURAN</h3>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-500 mb-1 flex items-center justify-between">INTERVAL (s) <button onclick="showHelp(event, 'interval')" class="help-btn">?</button></label>
                        <input type="number" id="interval" value="300" class="input-dark">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 mb-1 flex items-center justify-between">NAMA GRUP <button onclick="showHelp(event, 'group_name')" class="help-btn">?</button></label>
                        <input type="text" id="group-name" value="FLYCLASH" class="input-dark">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-500 mb-1 flex items-center justify-between">MIXED PORT <button onclick="showHelp(event, 'mixed_port')" class="help-btn">?</button></label>
                        <input type="number" id="mixed-port" value="7890" class="input-dark">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 mb-1 flex items-center justify-between">DNS MODE <button onclick="showHelp(event, 'dns')" class="help-btn">?</button></label>
                        <select id="dns-mode" onchange="toggleCustomDns()" class="input-dark">
                            <option value="default">Default</option>
                            <option value="fake-ip">‚ö° Fake-IP (Anti Bengong)</option>
                            <option value="custom">Custom IP</option>
                        </select>
                    </div>
                </div>
                
                <input type="text" id="custom-dns" value="8.8.8.8, 1.1.1.1" class="input-dark hidden" placeholder="8.8.8.8, 1.1.1.1">

                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-zinc-800">
                    <label class="check-item">
                        <div class="flex gap-2"><input type="checkbox" id="skip-cert" checked><span class="text-xs text-gray-300">Skip Cert</span></div>
                        <button onclick="showHelp(event, 'skip_cert')" class="help-btn">?</button>
                    </label>
                    <label class="check-item">
                        <div class="flex gap-2"><input type="checkbox" id="block-ads"><span class="text-xs text-gray-300">Block Ads</span></div>
                        <button onclick="showHelp(event, 'block_ads')" class="help-btn">?</button>
                    </label>
                    <label class="check-item">
                        <div class="flex gap-2"><input type="checkbox" id="top-prio" checked><span class="text-xs text-gray-300">Top Priority</span></div>
                        <button onclick="showHelp(event, 'top_prio')" class="help-btn">?</button>
                    </label>
                    <label class="check-item">
                        <div class="flex gap-2"><input type="checkbox" id="inject-sosmed"><span class="text-xs text-gray-300">Inject WA/TT</span></div>
                        <button onclick="showHelp(event, 'inject_sosmed')" class="help-btn">?</button>
                    </label>
                    <label class="check-item col-span-2">
                        <div class="flex gap-2"><input type="checkbox" id="allow-lan" checked><span class="text-xs text-gray-300">Allow LAN (Share Wifi)</span></div>
                        <button onclick="showHelp(event, 'allow_lan')" class="help-btn">?</button>
                    </label>
                </div>

                <button onclick="generateScript()" class="w-full py-3 bg-primary hover:bg-indigo-500 text-white font-bold rounded-lg mt-4 shadow-lg shadow-indigo-500/20 transition">GENERATE SCRIPT</button>
            </div>
        </div>

        <div class="lg:col-span-7">
            <div class="glass flex flex-col rounded-xl overflow-hidden h-[600px] border border-zinc-800">
                <div class="bg-zinc-900/80 p-3 border-b border-zinc-800 flex justify-between items-center">
                    <span class="text-xs font-mono text-primary flex items-center gap-2">üìÑ HASIL OUTPUT</span>
                    <div class="flex gap-2">
                        <button onclick="copyText()" class="text-xs bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-1 rounded border border-zinc-700">Copy</button>
                        <button onclick="downloadFile()" class="text-xs bg-primary hover:bg-indigo-600 text-white px-3 py-1 rounded">Save .js</button>
                    </div>
                </div>
                <textarea id="output-area" readonly class="flex-1 bg-black/50 p-4 font-mono text-xs leading-relaxed text-gray-300 resize-none focus:outline-none">
// 1. Masukkan akun Vmess/Vless/Trojan
// 2. Pilih Mode (Auto Ping / Manual / dll)
// 3. Klik Generate Script
                </textarea>
            </div>
        </div>
    </div>

    <div id="help-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeHelp()">
        <div class="bg-[#18181b] border border-zinc-700 w-full max-w-sm rounded-xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-lg font-bold text-primary mb-2">Title</h3>
            <p id="modal-desc" class="text-sm text-zinc-300 mb-4 whitespace-pre-line leading-relaxed">Desc</p>
            <button onclick="closeHelp()" class="w-full py-2 bg-zinc-800 rounded text-xs font-bold text-zinc-300 hover:bg-zinc-700">TUTUP</button>
        </div>
    </div>

    <script>
        // State
        const activeModes = new Set(['url-test']);
        
        // Data Penjelasan (Popup)
        const helpData = {
            'auto': {t: "Auto Ping", d: "Secara otomatis mengetes dan memilih akun dengan ping (latency) terendah agar koneksi selalu cepat."},
            'manual': {t: "Manual Select", d: "Anda harus memilih sendiri server/akun mana yang ingin digunakan di menu Proxy FlyClash."},
            'lb': {t: "Load Balance", d: "Menggabungkan bandwidth beberapa akun sekaligus. Request akan dibagi rata. Berguna untuk meningkatkan speed download."},
            'fallback': {t: "Fallback", d: "Sistem cadangan. Selalu menggunakan Akun Pertama. Jika mati, otomatis pindah ke Akun Kedua."},
            'interval': {t: "Interval Testing", d: "Jeda waktu (detik) untuk mengecek ping server. Standar: 300s. Set lebih kecil (150s) agar perpindahan Auto Ping lebih responsif."},
            'group_name': {t: "Nama Grup", d: "Label nama yang akan muncul di daftar Proxy aplikasi FlyClash."},
            'mixed_port': {t: "Mixed Port", d: "Port lokal proxy (HTTP/SOCKS5). Default FlyClash adalah 7890."},
            'allow_lan': {t: "Allow LAN (Share Wifi)", d: "Mengizinkan perangkat lain (HP/Laptop) yang terhubung ke Hotspot/Wifi HP Anda untuk ikut menggunakan koneksi VPN ini."},
            'dns': {t: "DNS Strategy", d: "- Fake-IP: Memaksa mode Fake-IP. Sangat ampuh mengatasi 'Connected tapi tidak ada internet'.\n- Custom: Memaksa DNS tertentu (8.8.8.8) untuk buka blokir."},
            'skip_cert': {t: "Skip Certificate", d: "Mematikan verifikasi SSL. WAJIB DI-CENTANG jika menggunakan akun gratisan/self-signed agar tidak error/timeout."},
            'block_ads': {t: "Block Ads", d: "Menambahkan aturan otomatis untuk memblokir domain iklan populer (Google Ads, DoubleClick, dll) agar hemat kuota."},
            'top_prio': {t: "Top Priority", d: "Menaruh grup proxy buatan generator ini di urutan PALING ATAS di menu FlyClash agar mudah ditemukan."},
            'inject_sosmed': {t: "Inject WA/TT", d: "Memaksa WhatsApp, TikTok, & Mobile Legends lewat proxy ini agar chat tidak pending dan ping game stabil."}
        };

        // UI Functions
        function toggleMode(mode) {
            const btn = document.getElementById('btn-' + mode);
            
            if (activeModes.has(mode)) {
                if (activeModes.size > 1) {
                    activeModes.delete(mode);
                    btn.classList.remove('active');
                }
            } else {
                activeModes.add(mode);
                btn.classList.add('active');
            }
        }

        function toggleCustomDns() {
            const val = document.getElementById('dns-mode').value;
            const input = document.getElementById('custom-dns');
            if (val === 'custom') input.classList.remove('hidden');
            else input.classList.add('hidden');
        }

        function clearInput() {
            document.getElementById('input-config').value = '';
            document.getElementById('node-count').innerText = '0 nodes';
        }

        function showHelp(e, key) {
            e.preventDefault(); // Mencegah checkbox terklik
            e.stopPropagation();
            const data = helpData[key];
            if(data) {
                document.getElementById('modal-title').innerText = data.t;
                document.getElementById('modal-desc').innerText = data.d;
                document.getElementById('help-modal').classList.remove('hidden');
            }
        }

        function closeHelp() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        // --- CORE LOGIC ---

        function parseConfig(line, index) {
            try {
                if (line.startsWith("vmess://")) {
                    const b64 = line.replace("vmess://", "");
                    const conf = JSON.parse(atob(b64));
                    return {
                        name: conf.ps || `VMess-${index}`, type: "vmess", server: conf.add, port: parseInt(conf.port), uuid: conf.id, alterId: parseInt(conf.aid || 0), cipher: "auto", tls: conf.tls === "tls", servername: conf.host || conf.sni || "", network: conf.net || "ws", "ws-opts": conf.net === "ws" ? { path: conf.path || "/", headers: { Host: conf.host || "" } } : undefined, "grpc-opts": conf.net === "grpc" ? { "grpc-service-name": conf.path || "grpc" } : undefined
                    };
                } else if (line.startsWith("vless://") || line.startsWith("trojan://")) {
                    const url = new URL(line);
                    const isVless = line.startsWith("vless://");
                    const params = url.searchParams;
                    const result = {
                        name: decodeURIComponent(url.hash.slice(1)) || `${isVless ? 'VLESS' : 'Trojan'}-${index}`, type: isVless ? "vless" : "trojan", server: url.hostname, port: parseInt(url.port), uuid: url.username, password: isVless ? undefined : url.username, tls: params.get("security") === "tls" || params.get("security") === "reality", servername: params.get("sni") || "", network: params.get("type") || "tcp", "client-fingerprint": params.get("fp") || "chrome",
                    };
                    if (params.get("type") === "ws") result["ws-opts"] = { path: params.get("path") || "/", headers: { Host: params.get("host") || params.get("sni") || "" } };
                    if (params.get("type") === "grpc") result["grpc-opts"] = { "grpc-service-name": params.get("serviceName") || "grpc" };
                    if (params.get("security") === "reality") result["reality-opts"] = { "public-key": params.get("pbk") || "", "short-id": params.get("sid") || "" };
                    return result;
                }
                return null;
            } catch (e) { return null; }
        }

        function generateScript() {
            const inputVal = document.getElementById('input-config').value;
            const lines = inputVal.split('\n').filter(l => l.trim().length > 5);
            
            const nodes = lines.map((l, i) => parseConfig(l.trim(), i)).filter(n => n !== null);
            document.getElementById('node-count').innerText = nodes.length + ' nodes';

            if (nodes.length === 0) {
                document.getElementById('output-area').value = "// Error: Config tidak valid atau kosong.";
                return;
            }

            // Get Settings
            const interval = document.getElementById('interval').value;
            const groupName = document.getElementById('group-name').value;
            const mixedPort = document.getElementById('mixed-port').value;
            const allowLan = document.getElementById('allow-lan').checked;
            const skipCert = document.getElementById('skip-cert').checked;
            const blockAds = document.getElementById('block-ads').checked;
            const topPrio = document.getElementById('top-prio').checked;
            const injectSosmed = document.getElementById('inject-sosmed').checked;
            const dnsMode = document.getElementById('dns-mode').value;
            const customDns = document.getElementById('custom-dns').value;

            // Apply Node Settings
            nodes.forEach(n => {
                if (skipCert) n['skip-cert-verify'] = true;
                n.udp = true;
            });

            // Build DNS
            let dnsConfig = "// DNS: Default";
            if(dnsMode === 'fake-ip') {
                dnsConfig = `config.dns = { "enable": true, "ipv6": false, "listen": "0.0.0.0:1053", "enhanced-mode": "fake-ip", "fake-ip-range": "198.18.0.1/16", "fake-ip-filter": ["*.lan", "*.local", "time.*.com", "wpad.+"], "default-nameserver": ["8.8.8.8", "1.1.1.1"], "nameserver": ["https://dns.google/dns-query", "https://1.1.1.1/dns-query"], "fallback": ["https://doh.pub/dns-query", "8.8.8.8"], "fallback-filter": { "geoip": true, "ipcidr": ["240.0.0.0/4"] } };`;
            } else if (dnsMode === 'custom') {
                dnsConfig = `if(!config.dns) config.dns = {}; config.dns.nameserver = ${JSON.stringify(customDns.split(',').map(s=>s.trim()))};`;
            }

            // Build Rules
            let extraRules = [];
            if(blockAds) extraRules.push("DOMAIN-KEYWORD,ads,REJECT", "DOMAIN-SUFFIX,doubleclick.net,REJECT");
            if(injectSosmed) extraRules.push(`DOMAIN-SUFFIX,whatsapp.com,${groupName} (AUTO)`, `DOMAIN-KEYWORD,whatsapp,${groupName} (AUTO)`, `DOMAIN-SUFFIX,tiktokv.com,${groupName} (AUTO)`);
            const rulesStr = JSON.stringify(extraRules);

            // Build Groups
            const activeModesArr = Array.from(activeModes);
            const groupsStr = activeModesArr.map(mode => {
                let niceName = mode === 'url-test' ? "AUTO" : mode === 'select' ? "MANUAL" : mode === 'load-balance' ? "LB" : "FALLBACK";
                return `{ "name": "${groupName} (${niceName})", "type": "${mode}", "url": "http://www.gstatic.com/generate_204", "interval": ${interval}, ${mode === 'load-balance' ? '"strategy": "consistent-hashing",' : ''} "proxies": proxies.map(p => p.name) }`;
            }).join(",\n    ");

            // Final Template
            const finalScript = `// FlyClash Converter Override
// Dev: Itsbad
// Modes: ${activeModesArr.join(', ')}
// Generated: ${new Date().toLocaleString()}

function main(config) {
    const proxies = ${JSON.stringify(nodes, null, 2)};
    config.proxies = (config.proxies || []).concat(proxies);
    
    const newGroups = [
    ${groupsStr}
    ];

    if (!config['proxy-groups']) config['proxy-groups'] = [];
    ${topPrio ? "config['proxy-groups'].unshift(...newGroups);" : "config['proxy-groups'].push(...newGroups);"}

    config['allow-lan'] = ${allowLan};
    config['mixed-port'] = ${mixedPort};
    config['ipv6'] = false;

    ${dnsConfig}

    const newRules = ${rulesStr};
    if(newRules.length > 0) config.rules = newRules.concat(config.rules || []);

    // Add to existing groups
    config['proxy-groups'].forEach(g => {
        if (g.type === 'select' && !newGroups.find(ng => ng.name === g.name)) {
            newGroups.forEach(ng => g.proxies.push(ng.name));
        }
    });

    return config;
}`;

            document.getElementById('output-area').value = finalScript;
        }

        function copyText() {
            const txt = document.getElementById('output-area');
            txt.select();
            document.execCommand('copy');
            alert("Berhasil disalin!");
        }

        function downloadFile() {
            const txt = document.getElementById('output-area').value;
            const blob = new Blob([txt], { type: "text/javascript" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = 'flyclash-override.js';
            a.click();
        }
    </script>
</body>
</html>
